from Cryptodome.Util import number
from Cryptodome.Util.number import long_to_bytes
from Cryptodome.Util.Padding import unpad
from Cryptodome.Cipher import AES
import random

# Implementazione Diffie-Hellman

def gen_safe_prime(bits = 1024):

    while True:
        q = number.getPrime(bits - 1)
        p = 2 * q + 1

        if number.isPrime(p):
            return p, q

def find_generator(p, q):
    for g in range(2, p - 1):
        if pow(g, 2, p) != 1 and pow(g, q, p) != 1:
            return g
        

# p, q = gen_safe_prime()

p = 122723003360068337194284670326472153759285417937192881443907280379771372649236578781177947704089288497353585754528862608099127740170147956614495202101365748285823990148831404814240098947356922861707429063184916686102069692551648395327568207840955640431875630139571966173518034871636527479208286802007135477943
q = 61361501680034168597142335163236076879642708968596440721953640189885686324618289390588973852044644248676792877264431304049563870085073978307247601050682874142911995074415702407120049473678461430853714531592458343051034846275824197663784103920477820215937815069785983086759017435818263739604143401003567738971

print("p = ", p)
print("q = ", q)

g = find_generator(p, q)

print(f"g = {g}\n")

# b = random.randint(1, q-1)
b = 8457544726016929713469284050789483522486515355506612101922391452453847716901554898168757981108806961643917119638806352965198028245034828365356127800314781642210216453786159512840469473902781853679725921166685147771606710280484541764976978237589353306376008874423418490739966011429698458809829221145057808713

print(f"Private key = {b}")

B = pow(g, b, p)

print(f"Public key = {B}\n")

A = "5a3fa0e21b537c8780c3a90a8c9277f7e8d8e7bec273c4bcab9e7119d8accd0c5643f6c75380040d8a7e9596053fd39bde51e633450950cdf8aa8e9fd70409d37acc827d5308003680d8ca1947d70d13dad4a438e2ba7662d525c556c5fa9d1a0293836206bc5736b0312ec9f84ec2711ce88cd65e6fc39d9589a8d2e8da86c4"
A = int(A, 16)

K = pow(A, b, p)

print(f"KEY = {K}\n")

# AES-CBC
iv = bytes.fromhex("94167f23b226142e46e4cce6b461354a")
msg = bytes.fromhex("8fe756b6922e523a79353b4b7e0256fc176b1b5184f184bfafeca4970f57861d1c84cd6a352b54f716386a49af52ee29b3830d68be9151eab0019fc0077e7676")

plain = AES.new(long_to_bytes(K)[:16], AES.MODE_CBC, iv).decrypt(msg)

print(plain.decode())